<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Snake Bubbles - Pro Edition</title>
    <style>
        :root {
            --neon-cyan: #00ffcc;
            --neon-pink: #ff3e3e;
            --neon-gold: #ffcc00;
            --bg-dark: #09090b;
        }

        body {
            margin: 0; padding: 0; background: var(--bg-dark); color: #fff;
            font-family: 'Segoe UI', Arial, sans-serif;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 100vh; overflow: hidden; touch-action: none;
        }

        #background-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; }

        #menu {
            position: absolute; background: rgba(5, 5, 10, 0.96);
            width: 100%; height: 100%; display: flex; flex-direction: column;
            align-items: center; justify-content: center; z-index: 100;
            backdrop-filter: blur(15px); text-align: center;
        }

        #menu-title {
            color: var(--neon-pink); font-size: 4.5rem; font-weight: 900; margin: 0;
            text-shadow: 0 0 15px rgba(255, 62, 62, 0.9), 0 0 30px rgba(0, 255, 204, 0.3);
            text-transform: uppercase;
        }

        #menu-hs { color: var(--neon-gold); font-size: 1.6rem; font-weight: bold; margin: 25px 0 20px 0; }
        #final-score { color: #ffffff; font-size: 2.2rem; margin-bottom: 30px; font-weight: 300; }

        .menu-btn {
            width: 260px; padding: 15px; margin: 8px;
            border: 3px solid var(--neon-cyan); background: transparent;
            color: var(--neon-cyan); font-size: 20px; border-radius: 60px;
            font-weight: 900; cursor: pointer; transition: 0.3s; text-transform: uppercase;
            text-decoration: none; display: inline-block;
        }
        .menu-btn:active { background: var(--neon-cyan); color: #000; box-shadow: 0 0 30px var(--neon-cyan); }
        
        .btn-facile { border-color: #00ff88; color: #00ff88; }
        .btn-normal { border-color: var(--neon-gold); color: var(--neon-gold); }
        .btn-difficile { border-color: var(--neon-pink); color: var(--neon-pink); }
        .btn-home { border-color: #fff; color: #fff; }

        canvas#game { background: #111118; border: 2px solid #222233; border-radius: 15px; display: block; }
        
        #ui { display: flex; justify-content: space-between; width: 90vw; max-width: 400px; margin-bottom: 10px; font-weight: bold; color: var(--neon-cyan); }
        #shield-timer { color: var(--neon-gold); font-size: 0.9rem; }
    </style>
</head>
<body>

    <canvas id="background-canvas"></canvas>

    <div id="menu">
        <h1 id="menu-title">SNAKE</h1>
        <p id="menu-hs">RECORD: 0</p>
        <p id="final-score" style="display:none;">SCORE FINAL: 0</p>
        
        <div id="difficulty-btns">
            <button class="menu-btn btn-facile" onclick="startGame(200, 'FACILE')">FACILE</button>
            <button class="menu-btn btn-normal" onclick="startGame(130, 'NORMAL')">NORMAL</button>
            <button class="menu-btn btn-difficile" onclick="startGame(80, 'DIFFICILE')">DIFFICILE</button>
        </div>
        
        <div id="post-game-btns" style="display:none;">
            <button class="menu-btn" onclick="showHome()">REJOUER</button>
            <a href="index.html" class="menu-btn btn-home">ACCUEIL</a>
        </div>
    </div>

    <div id="ui">
        <div>SCORE: <span id="score">0</span></div>
        <div id="shield-timer"></div>
    </div>

    <canvas id="game"></canvas>

    <div style="margin-top:20px; display: grid; grid-template-columns: repeat(3, 70px); gap: 10px;">
        <button class="menu-btn" style="grid-column:2; width:70px; padding:15px;" onpointerdown="handleDir(0,-20)">â–²</button>
        <button class="menu-btn" style="grid-column:1; width:70px; padding:15px;" onpointerdown="handleDir(-20,0)">â—€</button>
        <button class="menu-btn" style="grid-column:2; width:70px; padding:15px;" onpointerdown="handleDir(0,20)">â–¼</button>
        <button class="menu-btn" style="grid-column:3; width:70px; padding:15px;" onpointerdown="handleDir(20,0)">â–¶</button>
    </div>

    <script>
        const canvas = document.getElementById("game");
        const ctx = canvas.getContext("2d");
        const bgCanvas = document.getElementById("background-canvas");
        const bgCtx = bgCanvas.getContext("2d");
        
        let gridSize = 20, w, h, snake, food, dx, dy, nextDx, nextDy, score, gameTimeout, currentSpeed;
        let activePower = { type: null, timer: 0 }, powerUp = null;
        let highScore = localStorage.getItem("snakePro_HS") || 0;

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        function playSound(f, type='sine', d=0.1) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type; osc.frequency.setValueAtTime(f, audioCtx.currentTime);
            gain.gain.setValueAtTime(0.05, audioCtx.currentTime);
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(); osc.stop(audioCtx.currentTime + d);
        }

        function init() {
            bgCanvas.width = window.innerWidth; bgCanvas.height = window.innerHeight;
            const size = Math.min(window.innerWidth * 0.9, window.innerHeight * 0.45);
            canvas.width = canvas.height = Math.floor(size / gridSize) * gridSize;
            w = h = canvas.width;
            document.getElementById("menu-hs").innerText = "RECORD: " + highScore;
        }

        function startGame(speed, label) {
            currentSpeed = speed;
            score = 0; activePower = { type: null, timer: 0 }; powerUp = null;
            document.getElementById("menu").style.display = "none";
            document.getElementById("score").innerText = "0";
            document.getElementById("shield-timer").innerText = "";
            snake = [{x: 100, y: 100}, {x: 80, y: 100}, {x: 60, y: 100}];
            dx = 20; dy = 0; nextDx = 20; nextDy = 0;
            placeFood(); run();
        }

        function placeFood() {
            food = { x: Math.floor(Math.random()*(w/gridSize))*gridSize, y: Math.floor(Math.random()*(h/gridSize))*gridSize };
            if (score > 0 && score % 40 === 0) powerUp = { x: Math.floor(Math.random()*(w/gridSize))*gridSize, y: Math.floor(Math.random()*(h/gridSize))*gridSize };
        }

        function handleDir(nx, ny) { if ((nx !== 0 && dx === 0) || (ny !== 0 && dy === 0)) { nextDx = nx; nextDy = ny; } }

        function showGameOver() {
            if (score > highScore) { highScore = score; localStorage.setItem("snakePro_HS", score); }
            playSound(150, 'sine', 0.4);
            document.getElementById("menu-title").innerText = "GAME OVER";
            document.getElementById("final-score").innerText = "SCORE FINAL: " + score;
            document.getElementById("final-score").style.display = "block";
            document.getElementById("difficulty-btns").style.display = "none";
            document.getElementById("post-game-btns").style.display = "block";
            document.getElementById("menu").style.display = "flex";
        }

        function showHome() {
            document.getElementById("menu-title").innerText = "SNAKE";
            document.getElementById("difficulty-btns").style.display = "block";
            document.getElementById("post-game-btns").style.display = "none";
            document.getElementById("final-score").style.display = "none";
        }

        function run() {
            dx = nextDx; dy = nextDy;
            const head = { x: snake[0].x + dx, y: snake[0].y + dy };

            if (head.x < 0 || head.x >= w || head.y < 0 || head.y >= h || (snake.some(s => s.x === head.x && s.y === head.y) && activePower.type !== 'shield')) {
                showGameOver(); return;
            }

            snake.unshift(head);
            if (head.x === food.x && head.y === food.y) {
                score += 10; document.getElementById("score").innerText = score;
                playSound(600); placeFood();
            } else if (powerUp && head.x === powerUp.x && head.y === powerUp.y) {
                // BOUCLIER : 30 secondes (30000ms / currentSpeed)
                activePower = { type: 'shield', timer: Math.floor(30000 / currentSpeed) }; 
                powerUp = null; playSound(800, 'square');
            } else { snake.pop(); }

            if (activePower.timer > 0) {
                activePower.timer--;
                let secondsLeft = Math.ceil((activePower.timer * currentSpeed) / 1000);
                document.getElementById("shield-timer").innerText = "ðŸ›¡ï¸ " + secondsLeft + "s";
            } else { 
                activePower.type = null; 
                document.getElementById("shield-timer").innerText = ""; 
            }

            ctx.clearRect(0, 0, w, h);
            ctx.fillStyle = "#ff3e3e"; ctx.beginPath(); ctx.arc(food.x+10, food.y+10, 8, 0, 7); ctx.fill();
            if (powerUp) { ctx.fillStyle = "#0077ff"; ctx.beginPath(); ctx.arc(powerUp.x+10, powerUp.y+10, 10, 0, 7); ctx.fill(); }

            snake.forEach((seg, i) => {
                ctx.save(); ctx.translate(seg.x+10, seg.y+10);
                let color = (activePower.type) ? "#0077ff" : "#00ffcc";
                if (i === 0) {
                    if (dx>0) ctx.rotate(0); else if (dx<0) ctx.rotate(Math.PI);
                    else if (dy>0) ctx.rotate(Math.PI/2); else ctx.rotate(-Math.PI/2);
                    if (Math.floor(Date.now() / 300) % 5 === 0) {
                        ctx.strokeStyle = "red"; ctx.lineWidth = 2;
                        ctx.beginPath(); ctx.moveTo(10, 0); ctx.lineTo(18, 0);
                        ctx.moveTo(18,0); ctx.lineTo(21,-3); ctx.moveTo(18,0); ctx.lineTo(21,3);
                        ctx.stroke();
                    }
                    ctx.fillStyle = color; ctx.beginPath(); ctx.roundRect(-10, -10, 20, 20, [8, 2, 2, 8]); ctx.fill();
                    ctx.fillStyle = "white"; ctx.beginPath(); ctx.arc(4, -5, 3, 0, 7); ctx.arc(4, 5, 3, 0, 7); ctx.fill();
                    ctx.fillStyle = "black"; ctx.beginPath(); ctx.arc(5, -5, 1.5, 0, 7); ctx.arc(5, 5, 1.5, 0, 7); ctx.fill();
                } else {
                    ctx.fillStyle = i % 2 === 0 ? color : "#00d4aa";
                    let size = 18 - (i / snake.length) * 8;
                    ctx.beginPath(); ctx.roundRect(-size/2, -size/2, size, size, 4); ctx.fill();
                }
                ctx.restore();
            });

            gameTimeout = setTimeout(run, currentSpeed);
        }

        init(); window.addEventListener('resize', init);
        function drawBG() {
            bgCtx.clearRect(0,0,bgCanvas.width,bgCanvas.height);
            bgCtx.strokeStyle = "rgba(0, 255, 204, 0.1)";
            for(let i=0; i<15; i++) {
                bgCtx.beginPath();
                bgCtx.arc((i*100+Date.now()/50)%bgCanvas.width, (i*120+Date.now()/70)%bgCanvas.height, 15, 0, 7);
                bgCtx.stroke();
            }
            requestAnimationFrame(drawBG);
        }
        drawBG();
    </script>
</body>
</html>
